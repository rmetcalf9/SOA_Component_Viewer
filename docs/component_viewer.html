<html>
<head>

<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>


<!--js files for ic_soa_svg sheets-->
<script src="ic_soa_svg.js"></script>

<!-- css files for ic_soa_svg -->
<link rel="stylesheet" href="ic_soa_svg.css" type="text/css" charset="utf-8">

<!-- js files for getting IC SOA data from sheet -->
<script src="ic_soa_data.js" type="text/javascript"></script>

<script>
	var sheet_data = ic_soa_data_getSheetMetrics();
	var spreadsheetId=ic_soa_data_getSheetID();
	var dataObjects={};

	
	var QueryString = function () {
	  // This function is anonymous, is executed immediately and 
	  // the return value is assigned to QueryString!
	  var query_string = {};
	  var query = window.location.search.substring(1);
	  var vars = query.split("&");
	  for (var i=0;i<vars.length;i++) {
		var pair = vars[i].split("=");
			// If first entry with this name
		if (typeof query_string[pair[0]] === "undefined") {
		  query_string[pair[0]] = decodeURIComponent(pair[1]);
			// If second entry with this name
		} else if (typeof query_string[pair[0]] === "string") {
		  var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
		  query_string[pair[0]] = arr;
			// If third or later entry with this name
		} else {
		  query_string[pair[0]].push(decodeURIComponent(pair[1]));
		}
	  } 
	  return query_string;
	}();

	function GetMenu() {
		var ret = "";
		ret += '<p><a href="index.html">Index</a> <a href="javascript:displayNOPARAM()">Menu</a></p>';
		ret += '<div id="MAIN" style="display: none">';
		ret += '<h1>Viewing MAIN</h1>';
		ret += '</div>';
		return ret;
	};
	
	function LoadDoc() {
		//Check Auth
		board_checkAuth(LoadDoc2);
	};
	
	function LoadDoc2() {
		
		//Load Data
		ranges=[];
		var sm = ic_soa_data_getSheetList();
		for (i = 0; i < sm.length; i++) {
			ranges.push(sheet_data[sm[i]].datarange);
		}
		board_getDataRangesFromSheet(spreadsheetId,ranges,function (result) {
			dataObjects = ic_soa_data_getDataObject(sm,sheet_data,result,0);
			//console.log(dataObjects);
			if (QueryString.mode=="EDF") {
				if (typeof(QueryString.name)=="undefined") {
					displayNOPARAM();
				} else {
					var edfobj = ic_soa_data_getEDFFromName(QueryString.name, dataObjects);
					if (typeof(edfobj)=="undefined") {
					} else {
						displayEDF(edfobj.uid);
					};
				};
			} else if (QueryString.mode=="SYSTEM") {
				displaySYSTEM("SYSTEM");
			} else if (QueryString.mode=="INT") {
				displayINT("INT");
			} else {
				displayNOPARAM();
			};
			
		});
		
	
	};
	function getSYSTEMHtml(uid) {
		var ret = "";
		var system_object = dataObjects.SYSTEMs[uid];
		ret += GetMenu();


		var ints_to_draw = [];
		for (cur_do = 0; cur_do < dataObjects.INTkeys.length; cur_do++) {
			var cur_int = dataObjects.INTs[dataObjects.INTkeys[cur_do]];
			if (cur_int.target_system==system_object.name) ints_to_draw.push(cur_int);
		};
		var edfs_to_draw = [];
		for (cur_do = 0; cur_do < dataObjects.EDFkeys.length; cur_do++) {
			var cur_edf = dataObjects.EDFs[dataObjects.EDFkeys[cur_do]];
			if (cur_edf.source_system==system_object.name) edfs_to_draw.push(cur_edf);
		};
		var target_pres_to_draw = [];
		for (cur_do = 0; cur_do < dataObjects.PRESkeys.length; cur_do++) {
			var cur_pres = dataObjects.PRESs[dataObjects.PRESkeys[cur_do]];
			if (cur_pres.provider_system==system_object.name) target_pres_to_draw.push(cur_pres);
		};
		var source_pres_to_draw = [];
		for (cur_do = 0; cur_do < dataObjects.PRESkeys.length; cur_do++) {
			var cur_pres = dataObjects.PRESs[dataObjects.PRESkeys[cur_do]];
			for(var i = 0; i < cur_pres.known_clients.length; i++) {
				//console.log(cur_pres.known_clients[i]);
				if (cur_pres.known_clients[i]==system_object.name) source_pres_to_draw.push(cur_pres);
			}
		};
		
		//console.log("Ints:" + ints_to_draw.length);
		//console.log("EDFs:" + edfs_to_draw.length);
		//console.log("target_pres:" + target_pres_to_draw.length);
		//console.log("source_pres:" + source_pres_to_draw.length);

		ret += "<h1>System: " + system_object.name + "</h1>";
		
		var src_side_to_draw = (edfs_to_draw.length + target_pres_to_draw.length);
		var targ_side_to_draw = (ints_to_draw.length + source_pres_to_draw.length);

		var max_eles = src_side_to_draw;
		if (max_eles < targ_side_to_draw) max_eles = targ_side_to_draw;
		var svg_height = max_eles * 100;
		if (svg_height<100) svg_height = 100;
		
		var system_pos = {x:600, y:(svg_height/2)}

		ret += "<svg class=\"ic_soa_svg\" style=\"width: 1300; height: " + svg_height + ";\">";
		ret += ic_soa_svg_getMarkers();
		ret += ic_soa_svg_drawSystem(system_object.name,system_pos);

		var vert_pitch = 100; //Vertical distance between rows

		//Draw LEFT (target side)
		var pos = {x:250, y:50};
		if (src_side_to_draw > targ_side_to_draw) {
			pos.y += ((src_side_to_draw - targ_side_to_draw)/2)*vert_pitch;
		};
		//Draw INTS (on left)
		for (cur_do = 0; cur_do < ints_to_draw.length; cur_do++) {
			ret += ic_soa_svg_drawIntegration(
						ints_to_draw[cur_do].name,
						pos,
						"javascript:displayINT('" + ints_to_draw[cur_do].uid + "')"
			);
			ret += ic_soa_svg_drawArrow(ic_soa_svg_Integration_conectorPointLocation(pos,"right"),ic_soa_svg_System_conectorPointLocation(system_pos,"left"));
			pos.y = pos.y + vert_pitch;
		}
		//Draw SOURCE Presentation Services below the INTS (on left)
		for (cur_do = 0; cur_do < source_pres_to_draw.length; cur_do++) {
			ret += ic_soa_svg_drawPresentationService(
						source_pres_to_draw[cur_do].name,
						pos,
						"javascript:displayPRES('" + source_pres_to_draw[cur_do].uid + "')"
			);
			ret += ic_soa_svg_drawSyncServiceCall(ic_soa_svg_PresentationService_conectorPointLocation(pos,"right"),ic_soa_svg_System_conectorPointLocation(system_pos,"left"));
			pos.y = pos.y + vert_pitch;
		}
		
		//Draw RIGHT (source side)
		var pos = {x:1000, y:50};
		if (targ_side_to_draw > src_side_to_draw) {
			pos.y += ((targ_side_to_draw - src_side_to_draw)/2)*vert_pitch;
		};
		//Draw EDFS (on right)
		for (cur_do = 0; cur_do < edfs_to_draw.length; cur_do++) {
			ret += ic_soa_svg_drawEDF(
						edfs_to_draw[cur_do].name,
						pos,
						"javascript:displayEDF('" + edfs_to_draw[cur_do].uid + "')"
			);
			ret += ic_soa_svg_drawArrow(ic_soa_svg_System_conectorPointLocation(system_pos,"right"),ic_soa_svg_EDF_conectorPointLocation(pos,"left"));
			pos.y = pos.y + vert_pitch;
		}
		//Draw TARGET Presentation Services below the EDFS (on right)
		for (cur_do = 0; cur_do < target_pres_to_draw.length; cur_do++) {
			ret += ic_soa_svg_drawPresentationService(
						target_pres_to_draw[cur_do].name,
						pos,
						"javascript:displayPRES('" + target_pres_to_draw[cur_do].uid + "')"
			);
			ret += ic_soa_svg_drawSyncServiceCall(ic_soa_svg_System_conectorPointLocation(system_pos,"right"),ic_soa_svg_PresentationService_conectorPointLocation(pos,"left"));
			pos.y = pos.y + vert_pitch;
		}

		
		ret += "</svg>";		
		return ret;
	};
	function displaySYSTEM(uid) {
		document.getElementById('MAIN').innerHTML = getSYSTEMHtml(uid);
		document.getElementById('MAIN').style.display = 'inline';
	};
	
	function getEDFHtml(uid) {
	
		var ret = "";
		var curEDF = dataObjects.EDFs[uid];
		if (typeof(curEDF)=="undefined") {
			console.log("ERROR no EDF with uid " + uid);
			return;
		}

		var confluence_doc_url = "https://wiki.imperial.ac.uk/display/TIR/" + curEDF.name;
		
		var ints_to_draw = [];
		for (cur_do = 0; cur_do < dataObjects.INTkeys.length; cur_do++) {
			var cur_int = dataObjects.INTs[dataObjects.INTkeys[cur_do]];
			if (cur_int.source_edf==curEDF.name) ints_to_draw.push(cur_int);
		};
		//console.log(ints_to_draw);

		var svg_height = ints_to_draw.length * 100;
		if (svg_height<100) svg_height = 100;
		var source_sys_pos = {x:80, y:(svg_height/2)};
		var edf_pos = {x:350, y:(svg_height/2)};

		var source_system_object = ic_soa_data_getSystemFromName(curEDF.source_system,dataObjects);
		
		ret += '<table border=0 width="100%" height="100%"><tr><td colspan=2>'
		ret += GetMenu();
		ret += "<h1>EDF: " + curEDF.name + " (" + curEDF.status + ")</h1>";
		ret += "<svg class=\"ic_soa_svg\" style=\"width: 1300; height: " + svg_height + ";\">";
		ret += ic_soa_svg_getMarkers();
		ret += ic_soa_svg_drawSystem(curEDF.source_system,source_sys_pos,"javascript:displaySYSTEM('" + source_system_object.uid + "')");
		ret += ic_soa_svg_drawEDF(curEDF.name,edf_pos);
		ret += ic_soa_svg_drawArrow(ic_soa_svg_System_conectorPointLocation(source_sys_pos,"right"), ic_soa_svg_EDF_conectorPointLocation(edf_pos,"left"));

		var int_pos = {x:800, y:50};
		for (cur_do = 0; cur_do < ints_to_draw.length; cur_do++) {
			var target_system_object = ic_soa_data_getSystemFromName(ints_to_draw[cur_do].target_system,dataObjects);
			ret += ic_soa_svg_drawIntegrationWithTarget(
						ints_to_draw[cur_do].name,
						ints_to_draw[cur_do].target_system,
						int_pos,
						"javascript:displayINT('" + ints_to_draw[cur_do].uid + "')",
						"javascript:displaySYSTEM('" + target_system_object.uid + "')"
			);
			ret += ic_soa_svg_drawArrow( ic_soa_svg_EDF_conectorPointLocation(edf_pos,"right"),ic_soa_svg_Integration_conectorPointLocation(int_pos,"left"));
			int_pos.y = int_pos.y + 100;
		}
		
		ret += '</svg>';
		ret += '</tr></td>';
		
		var w = $( document ).width() - 400;
		
		ret += '<tr><td width="' + w + 'px" height="100%">';
		ret += '<iframe src="' + confluence_doc_url + '" scrolling="yes" height="100%" width="' + w + 'px" >';
		ret += '</iframe>';
		ret += '</td><td valign="top" align="left">';
		
		ret += '<table border=1>';
		ret += '<tr><th>EDF Name:</th><td>' + curEDF.name + '</td>';
		ret += '<tr><th>Development Status:</th><td>' + curEDF.status + '</td>';
		ret += '<tr><th>Source System:</th><td>' + curEDF.source_system + '</td>';
		ret += '<tr><th>Confluence Documentation:</th><td><a href="' + confluence_doc_url + '">Confluence</a></td>';
		ret += '<tr><th>Tags:</th><td>' + curEDF.tags + '</td>';
		ret += '</table>';
		
		ret += "</td></tr></table>";

		return ret;
	};
	function displayEDF(uid) {
		document.getElementById('MAIN').innerHTML = getEDFHtml(uid);
		document.getElementById('MAIN').style.display = 'inline';
	};
	function getINTHtml(uid) {
		var ret = "";
		var curINT = dataObjects.INTs[uid];
		if (typeof(curINT)=="undefined") {
			console.log("ERROR no Integration with uid " + uid);
			return;
		}

		var edf_pos = {x:180, y:50};
		var int_pos = {x:700, y:50};
		
		ret += GetMenu();
		
		ret += "<h1>Integration: " + curINT.name + " (" + curINT.status + ")</h1>";
		ret += "<svg class=\"ic_soa_svg\" style=\"width: 1300; height: 100;\">";
		ret += ic_soa_svg_getMarkers();
		
		var src_edf_obj = ic_soa_data_getEDFFromName(curINT.source_edf, dataObjects);
		//console.log(src_edf_obj);
		
		ret += ic_soa_svg_drawEDF(curINT.source_edf,edf_pos,"javascript:displayEDF('" + src_edf_obj.uid + "')");

		var target_system_object = ic_soa_data_getSystemFromName(curINT.target_system,dataObjects);
		
		ret += ic_soa_svg_drawIntegrationWithTarget(
			curINT.name,
			curINT.target_system,
			int_pos,
			undefined,
			"javascript:displaySYSTEM('" + target_system_object.uid + "')"
		);
		ret += ic_soa_svg_drawArrow( ic_soa_svg_EDF_conectorPointLocation(edf_pos,"right"),ic_soa_svg_Integration_conectorPointLocation(int_pos,"left"));
		
		ret += "</svg>";
		return ret;
	};
	function displayINT(uid) {
		document.getElementById('MAIN').innerHTML = getINTHtml(uid);
		document.getElementById('MAIN').style.display = 'inline';
	};
	function getPRESHtml(uid) {
		var ret = "";
		var curPRES = dataObjects.PRESs[uid];
		if (typeof(curPRES)=="undefined") {
			console.log("ERROR no Presentation Service with uid " + uid);
			return;
		}

		var client_systems_to_draw = curPRES.known_clients;
		var svg_height = client_systems_to_draw.length * 100;
		if (svg_height<100) svg_height = 100;


		ret += GetMenu();
		
		ret += "<h1>Presentation Service: " + curPRES.name + " (" + curPRES.status + ")</h1>";

		var provider_system_pos = {x:100, y:(svg_height/2)};
		var pres_pos = {x:500, y:(svg_height/2)};
		var provider_system_object = ic_soa_data_getSystemFromName(curPRES.provider_system, dataObjects);

		ret += "<svg class=\"ic_soa_svg\" style=\"width: 1300; height: " + svg_height + ";\">";
		ret += ic_soa_svg_getMarkers();

		ret += ic_soa_svg_drawSystem(curPRES.provider_system,provider_system_pos,"javascript:displaySYSTEM('" + provider_system_object.uid + "')");
		ret += ic_soa_svg_drawPresentationService(curPRES.name,pres_pos);
		ret += ic_soa_svg_drawSyncServiceCall(ic_soa_svg_System_conectorPointLocation(provider_system_pos,"right"), ic_soa_svg_PresentationService_conectorPointLocation(pres_pos,"left"));

		var client_system_pos = {x:900, y:50};
		for (cur_do = 0; cur_do < client_systems_to_draw.length; cur_do++) {
			var client_system_object = ic_soa_data_getSystemFromName(client_systems_to_draw[cur_do],dataObjects);
			ret += ic_soa_svg_drawSystem(
				client_system_object.name,
				client_system_pos,
				"javascript:displaySYSTEM('" + client_system_object.uid + "')"
			);
			ret += ic_soa_svg_drawSyncServiceCall( ic_soa_svg_PresentationService_conectorPointLocation(pres_pos,"right"),ic_soa_svg_System_conectorPointLocation(client_system_pos,"left"));
			client_system_pos.y = client_system_pos.y + 100;
		}


		ret += "</svg>";

		return ret;
	};
	function displayPRES(uid) {
		document.getElementById('MAIN').innerHTML = getPRESHtml(uid);
		document.getElementById('MAIN').style.display = 'inline';
	};
	function getPOINTHtml(uid) {
		var ret = "";
		var curPOINT = dataObjects.POINTs[uid];
		if (typeof(curPOINT)=="undefined") {
			console.log("ERROR no Point 2 Point Integration with uid " + uid);
			return;
		}

		var provider_systems_to_draw = curPOINT.provider_systems;
		var client_systems_to_draw = curPOINT.client_systems;

		var src_side_to_draw = (provider_systems_to_draw.length);
		var targ_side_to_draw = (client_systems_to_draw.length);

		var max_eles = src_side_to_draw;
		if (max_eles < targ_side_to_draw) max_eles = targ_side_to_draw;
		var svg_height = max_eles * 100;
		if (svg_height<100) svg_height = 100;

		ret += GetMenu();
		
		ret += "<h1>Point 2 Point Integration: " + curPOINT.name + " (" + curPOINT.status + ")</h1>";

		var point_pos = {x:500, y:(svg_height/2)};

		ret += "<svg class=\"ic_soa_svg\" style=\"width: 1300; height: " + svg_height + ";\">";
		ret += ic_soa_svg_getMarkers();

		ret += ic_soa_svg_drawPoint(curPOINT.name,point_pos);

		var vert_pitch = 100; //Vertical distance between rows

		//Draw left side (source/provider side)
		var provider_system_pos = {x:200, y:50};
		if (targ_side_to_draw > src_side_to_draw) {
			provider_system_pos.y += ((targ_side_to_draw - src_side_to_draw)/2)*vert_pitch;
		};
		for (cur_do = 0; cur_do < provider_systems_to_draw.length; cur_do++) {
			var provider_system_object = ic_soa_data_getSystemFromName(provider_systems_to_draw[cur_do],dataObjects);
			ret += ic_soa_svg_drawSystem(
				provider_system_object.name,
				provider_system_pos,
				"javascript:displaySYSTEM('" + provider_system_object.uid + "')"
			);
			ret += ic_soa_svg_drawArrow( ic_soa_svg_System_conectorPointLocation(provider_system_pos,"right"),ic_soa_svg_Point_conectorPointLocation(point_pos,"left"),true);
			provider_system_pos.y = provider_system_pos.y + vert_pitch;
		}

		//Draw right side (target/client side)
		var client_system_pos = {x:900, y:50};
		if (src_side_to_draw > targ_side_to_draw) {
			client_system_pos.y += ((src_side_to_draw - targ_side_to_draw)/2)*vert_pitch;
		};
		for (cur_do = 0; cur_do < client_systems_to_draw.length; cur_do++) {
			var client_system_object = ic_soa_data_getSystemFromName(client_systems_to_draw[cur_do],dataObjects);
			ret += ic_soa_svg_drawSystem(
				client_system_object.name,
				client_system_pos,
				"javascript:displaySYSTEM('" + client_system_object.uid + "')"
			);
			ret += ic_soa_svg_drawArrow( ic_soa_svg_Point_conectorPointLocation(point_pos,"right"),ic_soa_svg_System_conectorPointLocation(client_system_pos,"left"),true);
			client_system_pos.y = client_system_pos.y + vert_pitch;
		}

		ret += "</svg>";
		return ret;
	};
	function displayPOINT(uid) {
		document.getElementById('MAIN').innerHTML = getPOINTHtml(uid);
		document.getElementById('MAIN').style.display = 'inline';
	};
	function getNOPARAMHtml() {
		var ret = "";
		ret += GetMenu();
		
		ret += "<h1>Component Viewer</h1>";
		ret += "<table><tr>";

		ret += "<td valign=\"top\"><h2>Systems</h1>";
		ret += "<ul>";
		for (cur_do = 0; cur_do < dataObjects.SYSTEMkeys.length; cur_do++) {
			var cur_sys = dataObjects.SYSTEMs[dataObjects.SYSTEMkeys[cur_do]];
			ret += "<li><a href=\"javascript:displaySYSTEM('" + cur_sys.name + "');\">" + cur_sys.name + "</a></li>";
		}
		ret += "</ul></td>";

		ret += "<td valign=\"top\"><h2>EDFs</h1>";
		ret += "<ul>";
		for (cur_do = 0; cur_do < dataObjects.EDFkeys.length; cur_do++) {
			var cur_edf = dataObjects.EDFs[dataObjects.EDFkeys[cur_do]];
			ret += "<li><a href=\"javascript:displayEDF('" + cur_edf.uid + "')\">" + cur_edf.name + "</a></li>";
		}
		ret += "</ul></td>";

		ret += "<td valign=\"top\"><h2>Integrations</h1>";
		ret += "<ul>";
		for (cur_do = 0; cur_do < dataObjects.INTkeys.length; cur_do++) {
			var cur_int = dataObjects.INTs[dataObjects.INTkeys[cur_do]];
			ret += "<li><a href=\"javascript:displayINT('" + cur_int.uid + "')\">" + cur_int.name + "</a></li>";
		}
		ret += "</ul></td>";

		ret += "<td valign=\"top\"><h2>Presentation Services</h1>";
		ret += "<ul>";
		for (cur_do = 0; cur_do < dataObjects.PRESkeys.length; cur_do++) {
			var cur_int = dataObjects.PRESs[dataObjects.PRESkeys[cur_do]];
			ret += "<li><a href=\"javascript:displayPRES('" + cur_int.uid + "')\">" + cur_int.name + "</a></li>";
		}
		ret += "</ul></td>";

		ret += "<td valign=\"top\"><h2>Point 2 Point Integrations</h1>";
		ret += "<ul>";
		for (cur_do = 0; cur_do < dataObjects.POINTkeys.length; cur_do++) {
			var cur_p2p = dataObjects.POINTs[dataObjects.POINTkeys[cur_do]];
			ret += "<li><a href=\"javascript:displayPOINT('" + cur_p2p.uid + "')\">" + cur_p2p.name + "</a></li>";
		}
		ret += "</ul></td>";

		ret += "</tr></table>";
		return ret;
	};
	function displayNOPARAM() {
		document.getElementById('MAIN').innerHTML = getNOPARAMHtml();
		document.getElementById('MAIN').style.display = 'inline';
	};

	/*
  function resizeIframe(obj) {
    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
	obj.style.width= screen.width;
  }	*/
	
</script>

<!--js files for google sheets-->
<script src="board.js"></script>
<script src="https://apis.google.com/js/client.js?onload=LoadDoc"></script>

</head>
<body>
	<div id="MAIN" style="display: none">
		<h1>Viewing MAIN</h1>
	</div>
</body>
</html>
